<!DOCTYPE html>
<html lang="en">
<head>
    <% include ../partials/head.ejs %>
</head>
<body class="container">

    <% include ../partials/header.ejs %>

    <main class="main">
        <div class="notification notification__success hidden" id="successBlock" >
            <i class="fa fa-check-circle" aria-hidden="true"></i>
            <span class="notification__message"></span>
        </div>
        <h2 class="heading headeing__2">Available tickets list</h2>

        <div class="table-wrapper">
            <table class="table table--tickets">
                <thead class="table__head">
                <tr class="table__row table__row--head">
                    <th class="table__cell table__cell--head">ID</th>
                    <th class="table__cell table__cell--head">From City</th>
                    <th class="table__cell table__cell--head">To City</th>
                    <th class="table__cell table__cell--head">Dispatch / Arrival</th>
                    <th class="table__cell table__cell--head">Distance (km)</th>
                    <th class="table__cell table__cell--head">Duration (min)</th>
                    <th class="table__cell table__cell--head"></th>
                </tr>
                </thead>
                <tbody class="table__body">
                <% tickets.forEach(function(ticket) {%>
                <tr class="table__row">
                    <th class="table__cell"><%= ticket.id %></th>
                    <td class="table__cell"><%= ticket.cityFrom %></td>
                    <td class="table__cell"><%= ticket.cityTo %></td>
                    <td class="table__cell"><%= ticket.dTimeUTC %> / <%= ticket.aTimeUTC %></td>
                    <td class="table__cell"><%= ticket.distance %></td>
                    <td class="table__cell"><%= ticket.duration.departure %></td>
                    <td class="table__cell">
                        <!--todo remove JSON data from attribute -->
                        <button data-ticket="<%= JSON.stringify(ticket) %>" class="btn btn--success btn--buy-ticket">Buy</button>
                    </td>
                </tr>
                <% }) %>
                </tbody>
            </table>
        </div>
    </main>

    <% include ../partials/footer.ejs %>

    <script>
        (function() {
            'use strict';

            var buttons = document.getElementsByClassName('btn--buy-ticket');
            var successBlock = document.getElementById('successBlock');

            for (var i = 0; i < buttons.length; i++ ) {
                buttons[i].addEventListener('click', function(e) {
                    var ticket = e.srcElement.dataset.ticket;
                    var ajax = new XMLHttpRequest();

                    ajax.onreadystatechange = function() {
                        if (ajax.readyState === 4) {
                            var response = JSON.parse(ajax.responseText);

                            if (response.success) {
                                successBlock.querySelector('.notification__message').innerText = response.message;
                                successBlock.style.display = 'block';

                                setTimeout(function() {
                                    successBlock.style.display = 'none';
                                }, 3000);
                            } else {
                                successBlock.style.display = 'none';
                            }
                        }
                    };

                    ajax.open('PUT', window.location.href, true);
                    ajax.setRequestHeader('Content-Type', 'application/json')
                    ajax.send(ticket);
                }, false);
            }

        })();
    </script>

</body>
</html>